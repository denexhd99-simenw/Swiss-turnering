"use strict";(()=>{var e={};e.id=150,e.ids=[150],e.modules={517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2444:(e,t,s)=>{s.r(t),s.d(t,{headerHooks:()=>w,originalPathname:()=>f,patchFetch:()=>g,requestAsyncStorage:()=>d,routeModule:()=>p,serverHooks:()=>h,staticGenerationAsyncStorage:()=>c,staticGenerationBailout:()=>m});var a={};s.r(a),s.d(a,{POST:()=>u});var r=s(5419),n=s(9108),i=s(9678),o=s(8093);let l="SWISS";async function u(){if(await o._.match.count({where:{phase:l,player2Id:{not:null},winnerId:null}})>0)return new Response("Current Swiss round is not finished",{status:400});let e=await o._.player.findMany({where:{wins:{lt:3},losses:{lt:3}},select:{id:!0,wins:!0,losses:!0},orderBy:[{wins:"desc"},{losses:"asc"},{id:"asc"}]});if(e.length<2)return Response.json({success:!0,message:"Swiss stage finished"});let t=((await o._.match.aggregate({where:{phase:l},_max:{round:!0}}))._max.round??0)+1;if(await o._.match.count({where:{phase:l,round:t}})>0)return Response.json({success:!0,round:t,message:"Round already exists"});let s={};for(let t of e){let e=`${t.wins}-${t.losses}`;s[e]||(s[e]=[]),s[e].push(t)}let a=Array.from(new Set(e.map(e=>`${e.wins}-${e.losses}`))).sort((e,t)=>{let[s,a]=e.split("-").map(Number),[r,n]=t.split("-").map(Number);return r!==s?r-s:a-n}),r=[],n=null;for(let e of a){let t=function(e){let t=[...e];for(let e=t.length-1;e>0;e--){let s=Math.floor(Math.random()*(e+1)),a=t[e];t[e]=t[s],t[s]=a}return t}(s[e]);n&&t.unshift(n),n=t.length%2==1?t.pop()??null:null;for(let e=0;e<t.length;e+=2)r.push({player1Id:t[e].id,player2Id:t[e+1].id})}return await o._.$transaction(async e=>{for(let s of r)await e.match.create({data:{phase:l,round:t,player1Id:s.player1Id,player2Id:s.player2Id}});n&&(await e.match.create({data:{phase:l,round:t,player1Id:n.id,player2Id:null,winnerId:n.id}}),await e.player.update({where:{id:n.id},data:{wins:{increment:1},points:{increment:3}}}))}),Response.json({success:!0,round:t})}let p=new r.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/swiss/next/route",pathname:"/api/swiss/next",filename:"route",bundlePath:"app/api/swiss/next/route"},resolvedPagePath:"C:\\Users\\25simwek\\Downloads\\pingpong-turnering\\app\\api\\swiss\\next\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:d,staticGenerationAsyncStorage:c,serverHooks:h,headerHooks:w,staticGenerationBailout:m}=p,f="/api/swiss/next/route";function g(){return(0,i.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:c})}},8093:(e,t,s)=>{s.d(t,{_:()=>r});let a=require("@prisma/client"),r=global.prisma||new a.PrismaClient},5419:(e,t,s)=>{e.exports=s(517)}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),a=t.X(0,[638],()=>s(2444));module.exports=a})();