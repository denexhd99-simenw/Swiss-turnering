"use strict";(()=>{var e={};e.id=150,e.ids=[150],e.modules={2509:e=>{e.exports=require("firebase-admin")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2444:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>w,originalPathname:()=>m,patchFetch:()=>h,requestAsyncStorage:()=>d,routeModule:()=>u,serverHooks:()=>y,staticGenerationAsyncStorage:()=>p,staticGenerationBailout:()=>f});var a={};r.r(a),r.d(a,{POST:()=>c});var n=r(5419),i=r(9108),l=r(9678),s=r(3115);let o="SWISS";async function c(){if(await s._.match.count({where:{phase:o,player2Id:{not:null},winnerId:null}})>0)return new Response("Current Swiss round is not finished",{status:400});let e=await s._.player.findMany({where:{wins:{lt:3},losses:{lt:3}},select:{id:!0,wins:!0,losses:!0},orderBy:[{wins:"desc"},{losses:"asc"},{id:"asc"}]});if(e.length<2)return Response.json({success:!0,message:"Swiss stage finished"});let t=((await s._.match.aggregate({where:{phase:o},_max:{round:!0}}))._max.round??0)+1;if(await s._.match.count({where:{phase:o,round:t}})>0)return Response.json({success:!0,round:t,message:"Round already exists"});let r={};for(let t of e){let e=`${t.wins}-${t.losses}`;r[e]||(r[e]=[]),r[e].push(t)}let a=Array.from(new Set(e.map(e=>`${e.wins}-${e.losses}`))).sort((e,t)=>{let[r,a]=e.split("-").map(Number),[n,i]=t.split("-").map(Number);return n!==r?n-r:a-i}),n=[],i=null;for(let e of a){let t=function(e){let t=[...e];for(let e=t.length-1;e>0;e--){let r=Math.floor(Math.random()*(e+1)),a=t[e];t[e]=t[r],t[r]=a}return t}(r[e]);i&&t.unshift(i),i=t.length%2==1?t.pop()??null:null;for(let e=0;e<t.length;e+=2)n.push({player1Id:t[e].id,player2Id:t[e+1].id})}return await s._.$transaction(async e=>{for(let r of n)await e.match.create({data:{phase:o,round:t,player1Id:r.player1Id,player2Id:r.player2Id}});i&&(await e.match.create({data:{phase:o,round:t,player1Id:i.id,player2Id:null,winnerId:i.id}}),await e.player.update({where:{id:i.id},data:{wins:{increment:1},points:{increment:3}}}))}),Response.json({success:!0,round:t})}let u=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/swiss/next/route",pathname:"/api/swiss/next",filename:"route",bundlePath:"app/api/swiss/next/route"},resolvedPagePath:"C:\\Users\\25simwek\\Downloads\\pingpong-turnering\\app\\api\\swiss\\next\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:d,staticGenerationAsyncStorage:p,serverHooks:y,headerHooks:w,staticGenerationBailout:f}=u,m="/api/swiss/next/route";function h(){return(0,l.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:p})}},3115:(e,t,r)=>{r.d(t,{_:()=>h});let a=r(2509),n=a.apps.length?a.apps[0]:function(){let e=function(){let e=process.env.FIREBASE_PROJECT_ID,t=process.env.FIREBASE_CLIENT_EMAIL,r=function(){let e=process.env.FIREBASE_PRIVATE_KEY;if(e)return e.replace(/\\n/g,"\n")}();if(e&&t&&r)return{projectId:e,clientEmail:t,privateKey:r}}();return e?a.initializeApp({credential:a.credential.cert(e)}):a.initializeApp({credential:a.credential.applicationDefault()})}(),i=a.firestore(n);async function l(e){let t=i.collection("__meta").doc("counters");return i.runTransaction(async r=>{let a=await r.get(t),n=Number(a.exists?a.data()?.[e]??0:0)+1;return r.set(t,{[e]:n},{merge:!0}),n})}async function s(){return(await i.collection("departments").get()).docs.map(e=>e.data())}async function o(){return(await i.collection("players").get()).docs.map(e=>e.data())}async function c(){return(await i.collection("matches").get()).docs.map(e=>e.data())}function u(e,t){return t?e.filter(e=>{for(let[r,a]of Object.entries(t)){let t=e[r];if(a&&"object"==typeof a&&!Array.isArray(a)){if(Object.prototype.hasOwnProperty.call(a,"not")&&t===a.not||Object.prototype.hasOwnProperty.call(a,"lt")&&!(t<a.lt)||Object.prototype.hasOwnProperty.call(a,"lte")&&!(t<=a.lte)||Object.prototype.hasOwnProperty.call(a,"gt")&&!(t>a.gt)||Object.prototype.hasOwnProperty.call(a,"gte")&&!(t>=a.gte)||Object.prototype.hasOwnProperty.call(a,"in")&&!(Array.isArray(a.in)?a.in:[]).includes(t))return!1}else if(t!==a)return!1}return!0}):e}function d(e,t){if(!t)return[...e];let r=Array.isArray(t)?t:[t];return[...e].sort((e,t)=>{for(let a of r){let r=Object.keys(a)[0],n="desc"===a[r]?-1:1,i=e[r],l=t[r];if(i!==l){if(null==i)return -1*n;if(null==l)return 1*n;if(i<l)return -1*n;if(i>l)return 1*n}}return 0})}function p(e,t){return"number"!=typeof t?e:e.slice(0,t)}function y(e,t){if(!t)return e;let r={};for(let[a,n]of Object.entries(t))n&&(r[a]=e[a]);return r}function w(e,t){let r={...e};for(let[e,a]of Object.entries(t)){if(a&&"object"==typeof a&&!Array.isArray(a)){if("number"==typeof a.increment){r[e]=Number(r[e]??0)+a.increment;continue}if("number"==typeof a.decrement){r[e]=Number(r[e]??0)-a.decrement;continue}}r[e]=a}return r}async function f(e){let t=await s(),r=new Map(t.map(e=>[e.id,e]));return e.map(e=>({...e,department:r.get(e.departmentId)??null}))}async function m(e,t){if(!t)return e;let r=await o(),a=new Map(r.map(e=>[e.id,e]));return e.map(e=>({...e,player1:t.player1?e.player1Id?a.get(e.player1Id)??null:null:void 0,player2:t.player2?e.player2Id?a.get(e.player2Id)??null:null:void 0,winner:t.winner?e.winnerId?a.get(e.winnerId)??null:null:void 0}))}let h={player:{async findMany(e={}){let t=await o(),r=t=p(t=d(t=u(t,e.where),e.orderBy),e.take);return e.include?.department&&(r=await f(r)),e.select&&(r=r.map(t=>y(t,e.select))),r},async create(e){let t=await l("players"),r=e.data??{},a={id:t,name:r.name,points:r.points??0,wins:r.wins??0,losses:r.losses??0,departmentId:Number(r.departmentId)};return await i.collection("players").doc(String(t)).set(a),a},async delete(e){let t=Number(e.where?.id);return await i.collection("players").doc(String(t)).delete(),{id:t}},async update(e){let t=Number(e.where?.id),r=i.collection("players").doc(String(t)),a=await r.get();if(!a.exists)throw Error("Player not found");let n=w(a.data(),e.data??{});return await r.set(n),n},async updateMany(e){let t=u(await o(),e.where),r=0;for(let a of t){let t=w(a,e.data??{});await i.collection("players").doc(String(a.id)).set(t),r+=1}return{count:r}}},department:{async findMany(e={}){let t=await s();return(t=p(t=d(t=u(t,e.where),e.orderBy),e.take),e.select)?t.map(t=>y(t,e.select)):t},async findUnique(e){let t=Number(e.where?.id),r=await i.collection("departments").doc(String(t)).get();return r.exists?r.data():null},async create(e){let t=await l("departments"),r={id:t,name:e.data?.name};return await i.collection("departments").doc(String(t)).set(r),r},async delete(e){let t=Number(e.where?.id);return await i.collection("departments").doc(String(t)).delete(),{id:t}}},match:{async findMany(e={}){let t=await c(),r=t=p(t=d(t=u(t,e.where),e.orderBy),e.take);return e.include&&(r=await m(r,e.include)),e.select&&(r=r.map(t=>y(t,e.select))),r},async findUnique(e){let t=Number(e.where?.id),r=await i.collection("matches").doc(String(t)).get();if(!r.exists)return null;let a=r.data();return e.include?(await m([a],e.include))[0]:a},async findFirst(e={}){return(await this.findMany(e))[0]??null},count:async(e={})=>u(await c(),e.where).length,async aggregate(e={}){let t=u(await c(),e.where);return e._max?.round?{_max:{round:t.length?Math.max(...t.map(e=>Number(e.round??0))):null}}:{_max:{}}},async create(e){let t=await l("matches"),r=e.data??{},a={id:t,round:Number(r.round??1),phase:r.phase??"SWISS",player1Id:r.player1Id??null,player2Id:r.player2Id??null,winnerId:r.winnerId??null,createdAt:r.createdAt??new Date().toISOString()};return await i.collection("matches").doc(String(t)).set(a),a},async createMany(e){let t=Array.isArray(e.data)?e.data:[],r=0;for(let e of t)await this.create({data:e}),r+=1;return{count:r}},async update(e){let t=Number(e.where?.id),r=i.collection("matches").doc(String(t)),a=await r.get();if(!a.exists)throw Error("Match not found");let n=w(a.data(),e.data??{});return await r.set(n),n},async delete(e){let t=Number(e.where?.id);return await i.collection("matches").doc(String(t)).delete(),{id:t}},async deleteMany(e={}){let t=u(await c(),e.where),r=0;for(let e of t)await i.collection("matches").doc(String(e.id)).delete(),r+=1;return{count:r}}},$transaction:async e=>e(h)}},5419:(e,t,r)=>{e.exports=r(517)}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[638],()=>r(2444));module.exports=a})();