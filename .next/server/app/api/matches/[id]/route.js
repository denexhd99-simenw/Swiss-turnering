"use strict";(()=>{var e={};e.id=623,e.ids=[623],e.modules={2509:e=>{e.exports=require("firebase-admin")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9508:(e,t,a)=>{a.r(t),a.d(t,{headerHooks:()=>g,originalPathname:()=>b,patchFetch:()=>A,requestAsyncStorage:()=>m,routeModule:()=>y,serverHooks:()=>h,staticGenerationAsyncStorage:()=>f,staticGenerationBailout:()=>I});var r={};a.r(r),a.d(r,{PATCH:()=>w});var n=a(5419),i=a(9108),l=a(9678),s=a(3115);let o="SWISS",d="KNOCKOUT";function c(e){return`${e.wins}-${e.losses}`}async function u(){if(await s._.match.count({where:{phase:o,player2Id:{not:null},winnerId:null}})>0)return;let e=await s._.player.findMany({where:{wins:{lt:3},losses:{lt:3}},select:{id:!0,wins:!0,losses:!0},orderBy:[{wins:"desc"},{losses:"asc"},{id:"asc"}]});if(e.length<2)return;let t=((await s._.match.aggregate({where:{phase:o},_max:{round:!0}}))._max.round??0)+1;if(await s._.match.count({where:{phase:o,round:t}})>0)return;let a={};for(let t of e){let e=c(t);a[e]||(a[e]=[]),a[e].push(t)}let r=Array.from(new Set(e.map(c))).sort((e,t)=>{let[a,r]=e.split("-").map(Number),[n,i]=t.split("-").map(Number);return n!==a?n-a:r-i}),n=[],i=null;for(let e of r){let t=function(e){let t=[...e];for(let e=t.length-1;e>0;e--){let a=Math.floor(Math.random()*(e+1)),r=t[e];t[e]=t[a],t[a]=r}return t}(a[e]);i&&t.unshift(i),i=t.length%2==1?t.pop()??null:null;for(let e=0;e<t.length;e+=2)n.push({player1Id:t[e].id,player2Id:t[e+1].id})}await s._.$transaction(async e=>{for(let a of n)await e.match.create({data:{phase:o,round:t,player1Id:a.player1Id,player2Id:a.player2Id}});i&&(await e.match.create({data:{phase:o,round:t,player1Id:i.id,player2Id:null,winnerId:i.id}}),await e.player.update({where:{id:i.id},data:{wins:{increment:1},points:{increment:3}}}))})}async function p(){let e=await s._.match.findMany({where:{phase:d},orderBy:[{round:"asc"},{id:"asc"}]});if(0===e.length)return;let t=Math.max(...e.map(e=>e.round)),a=e.filter(e=>e.round===t);if(a.some(e=>null!==e.player2Id&&null===e.winnerId))return;let r=t+1;if(e.some(e=>e.round===r))return;let n=a.map(e=>e.winnerId??(null===e.player2Id?e.player1Id:null)).filter(e=>null!==e);n.length<=1||await s._.$transaction(async e=>{for(let t=0;t<n.length;t+=2){let a=n[t],i=n[t+1]??null;await e.match.create({data:{phase:d,round:r,player1Id:a,player2Id:i,winnerId:null===i?a:null}})}})}async function w(e,{params:t}){let a=Number(t.id),{winnerId:r}=await e.json(),n=Number(r);if(!Number.isInteger(a)||!Number.isInteger(n))return new Response("Invalid input",{status:400});let i=await s._.match.findUnique({where:{id:a}});if(!i)return new Response("Match not found",{status:404});if(!i.player1Id||!i.player2Id)return new Response("Cannot set winner on bye/TBA match",{status:400});if(n!==i.player1Id&&n!==i.player2Id)return new Response("Winner must be one of the players in the match",{status:400});if(i.phase===o){let e=n===i.player1Id?i.player2Id:i.player1Id,t=i.winnerId,r=t?t===i.player1Id?i.player2Id:i.player1Id:null;await s._.$transaction(async i=>{t&&r&&(await i.player.update({where:{id:t},data:{points:{decrement:3},wins:{decrement:1}}}),await i.player.update({where:{id:r},data:{losses:{decrement:1}}})),await i.player.update({where:{id:n},data:{points:{increment:3},wins:{increment:1}}}),await i.player.update({where:{id:e},data:{losses:{increment:1}}}),await i.match.update({where:{id:a},data:{winnerId:n}})}),await u()}else await s._.match.update({where:{id:a},data:{winnerId:n}}),i.phase===d&&await p();let l=await s._.match.findUnique({where:{id:a},include:{player1:!0,player2:!0,winner:!0}});return Response.json(l)}let y=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/matches/[id]/route",pathname:"/api/matches/[id]",filename:"route",bundlePath:"app/api/matches/[id]/route"},resolvedPagePath:"C:\\Users\\25simwek\\Downloads\\pingpong-turnering\\app\\api\\matches\\[id]\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:m,staticGenerationAsyncStorage:f,serverHooks:h,headerHooks:g,staticGenerationBailout:I}=y,b="/api/matches/[id]/route";function A(){return(0,l.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:f})}},3115:(e,t,a)=>{a.d(t,{_:()=>h});let r=a(2509),n=r.apps.length?r.apps[0]:function(){let e=function(){let e=process.env.FIREBASE_PROJECT_ID,t=process.env.FIREBASE_CLIENT_EMAIL,a=function(){let e=process.env.FIREBASE_PRIVATE_KEY;if(e)return e.replace(/\\n/g,"\n")}();if(e&&t&&a)return{projectId:e,clientEmail:t,privateKey:a}}();return e?r.initializeApp({credential:r.credential.cert(e)}):r.initializeApp({credential:r.credential.applicationDefault()})}(),i=r.firestore(n);async function l(e){let t=i.collection("__meta").doc("counters");return i.runTransaction(async a=>{let r=await a.get(t),n=Number(r.exists?r.data()?.[e]??0:0)+1;return a.set(t,{[e]:n},{merge:!0}),n})}async function s(){return(await i.collection("departments").get()).docs.map(e=>e.data())}async function o(){return(await i.collection("players").get()).docs.map(e=>e.data())}async function d(){return(await i.collection("matches").get()).docs.map(e=>e.data())}function c(e,t){return t?e.filter(e=>{for(let[a,r]of Object.entries(t)){let t=e[a];if(r&&"object"==typeof r&&!Array.isArray(r)){if(Object.prototype.hasOwnProperty.call(r,"not")&&t===r.not||Object.prototype.hasOwnProperty.call(r,"lt")&&!(t<r.lt)||Object.prototype.hasOwnProperty.call(r,"lte")&&!(t<=r.lte)||Object.prototype.hasOwnProperty.call(r,"gt")&&!(t>r.gt)||Object.prototype.hasOwnProperty.call(r,"gte")&&!(t>=r.gte)||Object.prototype.hasOwnProperty.call(r,"in")&&!(Array.isArray(r.in)?r.in:[]).includes(t))return!1}else if(t!==r)return!1}return!0}):e}function u(e,t){if(!t)return[...e];let a=Array.isArray(t)?t:[t];return[...e].sort((e,t)=>{for(let r of a){let a=Object.keys(r)[0],n="desc"===r[a]?-1:1,i=e[a],l=t[a];if(i!==l){if(null==i)return -1*n;if(null==l)return 1*n;if(i<l)return -1*n;if(i>l)return 1*n}}return 0})}function p(e,t){return"number"!=typeof t?e:e.slice(0,t)}function w(e,t){if(!t)return e;let a={};for(let[r,n]of Object.entries(t))n&&(a[r]=e[r]);return a}function y(e,t){let a={...e};for(let[e,r]of Object.entries(t)){if(r&&"object"==typeof r&&!Array.isArray(r)){if("number"==typeof r.increment){a[e]=Number(a[e]??0)+r.increment;continue}if("number"==typeof r.decrement){a[e]=Number(a[e]??0)-r.decrement;continue}}a[e]=r}return a}async function m(e){let t=await s(),a=new Map(t.map(e=>[e.id,e]));return e.map(e=>({...e,department:a.get(e.departmentId)??null}))}async function f(e,t){if(!t)return e;let a=await o(),r=new Map(a.map(e=>[e.id,e]));return e.map(e=>({...e,player1:t.player1?e.player1Id?r.get(e.player1Id)??null:null:void 0,player2:t.player2?e.player2Id?r.get(e.player2Id)??null:null:void 0,winner:t.winner?e.winnerId?r.get(e.winnerId)??null:null:void 0}))}let h={player:{async findMany(e={}){let t=await o(),a=t=p(t=u(t=c(t,e.where),e.orderBy),e.take);return e.include?.department&&(a=await m(a)),e.select&&(a=a.map(t=>w(t,e.select))),a},async create(e){let t=await l("players"),a=e.data??{},r={id:t,name:a.name,points:a.points??0,wins:a.wins??0,losses:a.losses??0,departmentId:Number(a.departmentId)};return await i.collection("players").doc(String(t)).set(r),r},async delete(e){let t=Number(e.where?.id);return await i.collection("players").doc(String(t)).delete(),{id:t}},async update(e){let t=Number(e.where?.id),a=i.collection("players").doc(String(t)),r=await a.get();if(!r.exists)throw Error("Player not found");let n=y(r.data(),e.data??{});return await a.set(n),n},async updateMany(e){let t=c(await o(),e.where),a=0;for(let r of t){let t=y(r,e.data??{});await i.collection("players").doc(String(r.id)).set(t),a+=1}return{count:a}}},department:{async findMany(e={}){let t=await s();return(t=p(t=u(t=c(t,e.where),e.orderBy),e.take),e.select)?t.map(t=>w(t,e.select)):t},async findUnique(e){let t=Number(e.where?.id),a=await i.collection("departments").doc(String(t)).get();return a.exists?a.data():null},async create(e){let t=await l("departments"),a={id:t,name:e.data?.name};return await i.collection("departments").doc(String(t)).set(a),a},async delete(e){let t=Number(e.where?.id);return await i.collection("departments").doc(String(t)).delete(),{id:t}}},match:{async findMany(e={}){let t=await d(),a=t=p(t=u(t=c(t,e.where),e.orderBy),e.take);return e.include&&(a=await f(a,e.include)),e.select&&(a=a.map(t=>w(t,e.select))),a},async findUnique(e){let t=Number(e.where?.id),a=await i.collection("matches").doc(String(t)).get();if(!a.exists)return null;let r=a.data();return e.include?(await f([r],e.include))[0]:r},async findFirst(e={}){return(await this.findMany(e))[0]??null},count:async(e={})=>c(await d(),e.where).length,async aggregate(e={}){let t=c(await d(),e.where);return e._max?.round?{_max:{round:t.length?Math.max(...t.map(e=>Number(e.round??0))):null}}:{_max:{}}},async create(e){let t=await l("matches"),a=e.data??{},r={id:t,round:Number(a.round??1),phase:a.phase??"SWISS",player1Id:a.player1Id??null,player2Id:a.player2Id??null,winnerId:a.winnerId??null,createdAt:a.createdAt??new Date().toISOString()};return await i.collection("matches").doc(String(t)).set(r),r},async createMany(e){let t=Array.isArray(e.data)?e.data:[],a=0;for(let e of t)await this.create({data:e}),a+=1;return{count:a}},async update(e){let t=Number(e.where?.id),a=i.collection("matches").doc(String(t)),r=await a.get();if(!r.exists)throw Error("Match not found");let n=y(r.data(),e.data??{});return await a.set(n),n},async delete(e){let t=Number(e.where?.id);return await i.collection("matches").doc(String(t)).delete(),{id:t}},async deleteMany(e={}){let t=c(await d(),e.where),a=0;for(let e of t)await i.collection("matches").doc(String(e.id)).delete(),a+=1;return{count:a}}},$transaction:async e=>e(h)}},5419:(e,t,a)=>{e.exports=a(517)}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[638],()=>a(9508));module.exports=r})();