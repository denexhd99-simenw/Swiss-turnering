"use strict";(()=>{var e={};e.id=623,e.ids=[623],e.modules={517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8670:(e,a,t)=>{t.r(a),t.d(a,{headerHooks:()=>I,originalPathname:()=>_,patchFetch:()=>b,requestAsyncStorage:()=>m,routeModule:()=>w,serverHooks:()=>f,staticGenerationAsyncStorage:()=>y,staticGenerationBailout:()=>g});var n={};t.r(n),t.d(n,{PATCH:()=>h});var r=t(5419),i=t(9108),l=t(9678),s=t(8093);let d="SWISS",u="KNOCKOUT";function o(e){return`${e.wins}-${e.losses}`}async function p(){if(await s._.match.count({where:{phase:d,player2Id:{not:null},winnerId:null}})>0)return;let e=await s._.player.findMany({where:{wins:{lt:3},losses:{lt:3}},select:{id:!0,wins:!0,losses:!0},orderBy:[{wins:"desc"},{losses:"asc"},{id:"asc"}]});if(e.length<2)return;let a=((await s._.match.aggregate({where:{phase:d},_max:{round:!0}}))._max.round??0)+1;if(await s._.match.count({where:{phase:d,round:a}})>0)return;let t={};for(let a of e){let e=o(a);t[e]||(t[e]=[]),t[e].push(a)}let n=Array.from(new Set(e.map(o))).sort((e,a)=>{let[t,n]=e.split("-").map(Number),[r,i]=a.split("-").map(Number);return r!==t?r-t:n-i}),r=[],i=null;for(let e of n){let a=function(e){let a=[...e];for(let e=a.length-1;e>0;e--){let t=Math.floor(Math.random()*(e+1)),n=a[e];a[e]=a[t],a[t]=n}return a}(t[e]);i&&a.unshift(i),i=a.length%2==1?a.pop()??null:null;for(let e=0;e<a.length;e+=2)r.push({player1Id:a[e].id,player2Id:a[e+1].id})}await s._.$transaction(async e=>{for(let t of r)await e.match.create({data:{phase:d,round:a,player1Id:t.player1Id,player2Id:t.player2Id}});i&&(await e.match.create({data:{phase:d,round:a,player1Id:i.id,player2Id:null,winnerId:i.id}}),await e.player.update({where:{id:i.id},data:{wins:{increment:1},points:{increment:3}}}))})}async function c(){let e=await s._.match.findMany({where:{phase:u},orderBy:[{round:"asc"},{id:"asc"}]});if(0===e.length)return;let a=Math.max(...e.map(e=>e.round)),t=e.filter(e=>e.round===a);if(t.some(e=>null!==e.player2Id&&null===e.winnerId))return;let n=a+1;if(e.some(e=>e.round===n))return;let r=t.map(e=>e.winnerId??(null===e.player2Id?e.player1Id:null)).filter(e=>null!==e);r.length<=1||await s._.$transaction(async e=>{for(let a=0;a<r.length;a+=2){let t=r[a],i=r[a+1]??null;await e.match.create({data:{phase:u,round:n,player1Id:t,player2Id:i,winnerId:null===i?t:null}})}})}async function h(e,{params:a}){let t=Number(a.id),{winnerId:n}=await e.json(),r=Number(n);if(!Number.isInteger(t)||!Number.isInteger(r))return new Response("Invalid input",{status:400});let i=await s._.match.findUnique({where:{id:t}});if(!i)return new Response("Match not found",{status:404});if(!i.player1Id||!i.player2Id)return new Response("Cannot set winner on bye/TBA match",{status:400});if(r!==i.player1Id&&r!==i.player2Id)return new Response("Winner must be one of the players in the match",{status:400});if(i.phase===d){let e=r===i.player1Id?i.player2Id:i.player1Id,a=i.winnerId,n=a?a===i.player1Id?i.player2Id:i.player1Id:null;await s._.$transaction(async i=>{a&&n&&(await i.player.update({where:{id:a},data:{points:{decrement:3},wins:{decrement:1}}}),await i.player.update({where:{id:n},data:{losses:{decrement:1}}})),await i.player.update({where:{id:r},data:{points:{increment:3},wins:{increment:1}}}),await i.player.update({where:{id:e},data:{losses:{increment:1}}}),await i.match.update({where:{id:t},data:{winnerId:r}})}),await p()}else await s._.match.update({where:{id:t},data:{winnerId:r}}),i.phase===u&&await c();let l=await s._.match.findUnique({where:{id:t},include:{player1:!0,player2:!0,winner:!0}});return Response.json(l)}let w=new r.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/matches/[id]/route",pathname:"/api/matches/[id]",filename:"route",bundlePath:"app/api/matches/[id]/route"},resolvedPagePath:"C:\\Users\\25simwek\\Downloads\\pingpong-turnering\\app\\api\\matches\\[id]\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:m,staticGenerationAsyncStorage:y,serverHooks:f,headerHooks:I,staticGenerationBailout:g}=w,_="/api/matches/[id]/route";function b(){return(0,l.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:y})}},8093:(e,a,t)=>{t.d(a,{_:()=>r});let n=require("@prisma/client"),r=global.prisma||new n.PrismaClient},5419:(e,a,t)=>{e.exports=t(517)}};var a=require("../../../../webpack-runtime.js");a.C(e);var t=e=>a(a.s=e),n=a.X(0,[638],()=>t(8670));module.exports=n})();