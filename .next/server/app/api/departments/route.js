"use strict";(()=>{var e={};e.id=384,e.ids=[384],e.modules={2509:e=>{e.exports=require("firebase-admin")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9005:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>w,originalPathname:()=>g,patchFetch:()=>h,requestAsyncStorage:()=>p,routeModule:()=>u,serverHooks:()=>y,staticGenerationAsyncStorage:()=>m,staticGenerationBailout:()=>f});var n={};r.r(n),r.d(n,{DELETE:()=>d,GET:()=>l,POST:()=>c});var a=r(5419),i=r(9108),s=r(9678),o=r(3115);async function l(){return Response.json(await o._.department.findMany())}async function c(e){let t=await e.json();if(!t.name)return new Response("Missing name",{status:400});let r=await o._.department.create({data:{name:t.name}});return Response.json(r)}async function d(e){let t=await e.json(),r=Number(t.departmentId);if(!Number.isInteger(r))return new Response("Missing departmentId",{status:400});if(!await o._.department.findUnique({where:{id:r}}))return new Response("Department not found",{status:404});let n=await o._.player.findMany({where:{departmentId:r},select:{id:!0,name:!0}});if(0===n.length)return await o._.department.delete({where:{id:r}}),Response.json({success:!0});let a=Array.isArray(t.reassignments)?t.reassignments:[],i=new Map;for(let e of a){let t=Number(e.playerId),r=Number(e.departmentId);Number.isInteger(t)&&Number.isInteger(r)&&i.set(t,r)}if(n.some(e=>!i.has(e.id)))return Response.json({error:"All players must be reassigned before deletion"},{status:400});let s=Array.from(new Set(Array.from(i.values())));if(s.some(e=>e===r))return Response.json({error:"Cannot reassign to the department being deleted"},{status:400});let l=await o._.department.findMany({where:{id:{in:s}},select:{id:!0}}),c=new Set(l.map(e=>e.id));return s.some(e=>!c.has(e))?Response.json({error:"One or more target departments do not exist"},{status:400}):(await o._.$transaction(async e=>{for(let t of n)await e.player.update({where:{id:t.id},data:{departmentId:i.get(t.id)}});await e.department.delete({where:{id:r}})}),Response.json({success:!0}))}let u=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/departments/route",pathname:"/api/departments",filename:"route",bundlePath:"app/api/departments/route"},resolvedPagePath:"C:\\Users\\25simwek\\Downloads\\pingpong-turnering\\app\\api\\departments\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:p,staticGenerationAsyncStorage:m,serverHooks:y,headerHooks:w,staticGenerationBailout:f}=u,g="/api/departments/route";function h(){return(0,s.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:m})}},3115:(e,t,r)=>{r.d(t,{_:()=>g});let n=r(2509),a=n.apps.length?n.apps[0]:function(){let e=function(){let e=process.env.FIREBASE_PROJECT_ID,t=process.env.FIREBASE_CLIENT_EMAIL,r=function(){let e=process.env.FIREBASE_PRIVATE_KEY;if(e)return e.replace(/\\n/g,"\n")}();if(e&&t&&r)return{projectId:e,clientEmail:t,privateKey:r}}();return e?n.initializeApp({credential:n.credential.cert(e)}):n.initializeApp({credential:n.credential.applicationDefault()})}(),i=n.firestore(a);async function s(e){let t=i.collection("__meta").doc("counters");return i.runTransaction(async r=>{let n=await r.get(t),a=Number(n.exists?n.data()?.[e]??0:0)+1;return r.set(t,{[e]:a},{merge:!0}),a})}async function o(){return(await i.collection("departments").get()).docs.map(e=>e.data())}async function l(){return(await i.collection("players").get()).docs.map(e=>e.data())}async function c(){return(await i.collection("matches").get()).docs.map(e=>e.data())}function d(e,t){return t?e.filter(e=>{for(let[r,n]of Object.entries(t)){let t=e[r];if(n&&"object"==typeof n&&!Array.isArray(n)){if(Object.prototype.hasOwnProperty.call(n,"not")&&t===n.not||Object.prototype.hasOwnProperty.call(n,"lt")&&!(t<n.lt)||Object.prototype.hasOwnProperty.call(n,"lte")&&!(t<=n.lte)||Object.prototype.hasOwnProperty.call(n,"gt")&&!(t>n.gt)||Object.prototype.hasOwnProperty.call(n,"gte")&&!(t>=n.gte)||Object.prototype.hasOwnProperty.call(n,"in")&&!(Array.isArray(n.in)?n.in:[]).includes(t))return!1}else if(t!==n)return!1}return!0}):e}function u(e,t){if(!t)return[...e];let r=Array.isArray(t)?t:[t];return[...e].sort((e,t)=>{for(let n of r){let r=Object.keys(n)[0],a="desc"===n[r]?-1:1,i=e[r],s=t[r];if(i!==s){if(null==i)return -1*a;if(null==s)return 1*a;if(i<s)return -1*a;if(i>s)return 1*a}}return 0})}function p(e,t){return"number"!=typeof t?e:e.slice(0,t)}function m(e,t){if(!t)return e;let r={};for(let[n,a]of Object.entries(t))a&&(r[n]=e[n]);return r}function y(e,t){let r={...e};for(let[e,n]of Object.entries(t)){if(n&&"object"==typeof n&&!Array.isArray(n)){if("number"==typeof n.increment){r[e]=Number(r[e]??0)+n.increment;continue}if("number"==typeof n.decrement){r[e]=Number(r[e]??0)-n.decrement;continue}}r[e]=n}return r}async function w(e){let t=await o(),r=new Map(t.map(e=>[e.id,e]));return e.map(e=>({...e,department:r.get(e.departmentId)??null}))}async function f(e,t){if(!t)return e;let r=await l(),n=new Map(r.map(e=>[e.id,e]));return e.map(e=>({...e,player1:t.player1?e.player1Id?n.get(e.player1Id)??null:null:void 0,player2:t.player2?e.player2Id?n.get(e.player2Id)??null:null:void 0,winner:t.winner?e.winnerId?n.get(e.winnerId)??null:null:void 0}))}let g={player:{async findMany(e={}){let t=await l(),r=t=p(t=u(t=d(t,e.where),e.orderBy),e.take);return e.include?.department&&(r=await w(r)),e.select&&(r=r.map(t=>m(t,e.select))),r},async create(e){let t=await s("players"),r=e.data??{},n={id:t,name:r.name,points:r.points??0,wins:r.wins??0,losses:r.losses??0,departmentId:Number(r.departmentId)};return await i.collection("players").doc(String(t)).set(n),n},async delete(e){let t=Number(e.where?.id);return await i.collection("players").doc(String(t)).delete(),{id:t}},async update(e){let t=Number(e.where?.id),r=i.collection("players").doc(String(t)),n=await r.get();if(!n.exists)throw Error("Player not found");let a=y(n.data(),e.data??{});return await r.set(a),a},async updateMany(e){let t=d(await l(),e.where),r=0;for(let n of t){let t=y(n,e.data??{});await i.collection("players").doc(String(n.id)).set(t),r+=1}return{count:r}}},department:{async findMany(e={}){let t=await o();return(t=p(t=u(t=d(t,e.where),e.orderBy),e.take),e.select)?t.map(t=>m(t,e.select)):t},async findUnique(e){let t=Number(e.where?.id),r=await i.collection("departments").doc(String(t)).get();return r.exists?r.data():null},async create(e){let t=await s("departments"),r={id:t,name:e.data?.name};return await i.collection("departments").doc(String(t)).set(r),r},async delete(e){let t=Number(e.where?.id);return await i.collection("departments").doc(String(t)).delete(),{id:t}}},match:{async findMany(e={}){let t=await c(),r=t=p(t=u(t=d(t,e.where),e.orderBy),e.take);return e.include&&(r=await f(r,e.include)),e.select&&(r=r.map(t=>m(t,e.select))),r},async findUnique(e){let t=Number(e.where?.id),r=await i.collection("matches").doc(String(t)).get();if(!r.exists)return null;let n=r.data();return e.include?(await f([n],e.include))[0]:n},async findFirst(e={}){return(await this.findMany(e))[0]??null},count:async(e={})=>d(await c(),e.where).length,async aggregate(e={}){let t=d(await c(),e.where);return e._max?.round?{_max:{round:t.length?Math.max(...t.map(e=>Number(e.round??0))):null}}:{_max:{}}},async create(e){let t=await s("matches"),r=e.data??{},n={id:t,round:Number(r.round??1),phase:r.phase??"SWISS",player1Id:r.player1Id??null,player2Id:r.player2Id??null,winnerId:r.winnerId??null,createdAt:r.createdAt??new Date().toISOString()};return await i.collection("matches").doc(String(t)).set(n),n},async createMany(e){let t=Array.isArray(e.data)?e.data:[],r=0;for(let e of t)await this.create({data:e}),r+=1;return{count:r}},async update(e){let t=Number(e.where?.id),r=i.collection("matches").doc(String(t)),n=await r.get();if(!n.exists)throw Error("Match not found");let a=y(n.data(),e.data??{});return await r.set(a),a},async delete(e){let t=Number(e.where?.id);return await i.collection("matches").doc(String(t)).delete(),{id:t}},async deleteMany(e={}){let t=d(await c(),e.where),r=0;for(let e of t)await i.collection("matches").doc(String(e.id)).delete(),r+=1;return{count:r}}},$transaction:async e=>e(g)}},5419:(e,t,r)=>{e.exports=r(517)}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[638],()=>r(9005));module.exports=n})();